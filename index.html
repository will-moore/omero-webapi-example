

<html>

<style>

#base_url {
  width: 300px
}

</style>

<body>

  <form id="server_form">
    <input id="base_url" type="text" name="base_url" placeholder="http://localhost:4080/api/">
    <button type="submit">Load</button>
  </form>

  <hr>

  <form id="login_form">
    Server: <select id="server"></select><br>
    Username: <input id="username" type="text" name="username" placeholder="username"><br>
    Password: <input id="password" type="text" name="password" placeholder="password">
    <button type="submit">Login</button>
  </form>

  <hr>

  <div id="response">
  </div>

<script>

var latest_base_url;
var base_urls;
var csrf_token;

function showResponse(text) {

  document.getElementById('response').innerHTML = text;
}

function createCORSRequest(method, url) {
  var xhr = new XMLHttpRequest();
  if ("withCredentials" in xhr) {
    // Check if the XMLHttpRequest object has a "withCredentials" property.
    // "withCredentials" only exists on XMLHTTPRequest2 objects.
    xhr.open(method, url, true);
  } else if (typeof XDomainRequest != "undefined") {
    // Otherwise, check if XDomainRequest.
    // XDomainRequest only exists in IE, and is IE's way of making CORS requests.
    xhr = new XDomainRequest();
    xhr.open(method, url);
  } else {
    // Otherwise, CORS is not supported by the browser.
    xhr = null;
  }

  xhr.onerror = function() {
    console.log('There was an error!');
  };
  return xhr;
}

function makeJSONRequest(method, url, callback, data) {
  console.log(method, url);
  var xhr = createCORSRequest(method, url);

  xhr.onload = function() {
    var responseText = xhr.responseText;
    var jsonResponse = JSON.parse(responseText);
    console.log(jsonResponse);
    // handle the response.
    if (callback) {
      callback(jsonResponse);
    }
  };

  if (data) {
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

    xhr.setRequestHeader('X-CSRFToken', csrf_token);
    // always add CSRF token
    // data += '&csrfmiddlewaretoken=' + csrf_token;
    xhr.send(data);
  } else {
    xhr.send();
  }
}

function loadBaseUrls(callback) {
  makeJSONRequest('GET', latest_base_url, function(rsp) {
    base_urls = rsp;
    callback();
  });
}

function prepareLogin() {
  // Get available servers
  var servers_url = base_urls['url:servers'];
  makeJSONRequest('GET', servers_url, function(rsp) {
    var serversHtml = rsp.data.map(function(s){
      return '<option value="' + s.id + '">' + s.server + ':' + s.port + '</option>';
    });
    document.getElementById('server').innerHTML = serversHtml.join("");
  });

  // Also get CSRF token needed for login and other POST requests
  var token_url = base_urls['url:token'];
  makeJSONRequest('GET', token_url, function(rsp) {
    csrf_token = rsp.data;
  });
}

document.getElementById('server_form').addEventListener('submit', function(event) {
  event.preventDefault();

  var omeroServer = document.getElementById('base_url').value;
  console.log('omeroServer', omeroServer);

  makeJSONRequest('GET', omeroServer, function(rsp) {
    // List of supported versions
    var versions = rsp.data;
    // Get base_url from last version in the list
    latest_base_url = versions[versions.length-1]["url:base"];
    showResponse('Connecting to ' + latest_base_url);

    // Get the list of top-level urls as starting points, then prepare login form
    loadBaseUrls(prepareLogin);
  });

  return false;
});


document.getElementById('login_form').addEventListener('submit', function(event) {
  event.preventDefault();

  var login_url = base_urls['url:login'];

  var fields = ['username', 'password', 'server'];
  var data = fields.map(function(f){
    return f + '=' + document.getElementById(f).value
  });
  data = data.join('&');
  console.log(data);

  makeJSONRequest('POST', login_url, function(rsp) {
    // Will get eventContext if login OK
    console.log(rsp);
    
  }, data);

  return false;
});

</script>

</body>
</html>
