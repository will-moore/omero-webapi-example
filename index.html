

<html>

<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<style>

#base_url_container {
  z-index: 100;
}

.full_page {
  height: 100%;
  width: 100%;
  position: absolute;
  top: 0;
  z-index: 0;
  background-color: #eee;
}

.full_page input {
  margin-bottom: 20px;
  padding: 10px;
  font-size: 16px;
  height: auto;
}

#username {
  margin-bottom: 5px;
}

body {
  background-color: #eee;
}

#server_form, #login_form {
  max-width: 430px;
  padding-top: 55px;
  margin: 0 auto;

}

</style>

<body>

  <div id="base_url_container" class="full_page container">
    <form id="server_form">
      <h2>Enter OMERO.web url</h2>
      <input id="base_url" type="text" class="form-control" placeholder="e.g. http://localhost:4080/" required autofocus>
      <button class="btn btn-lg btn-primary btn-block" type="submit">Connect</button>
    </form>
  </div>

  <div id="login_container" class="full_page container">
    <form id="login_form">
      <h2>Login to OMERO</h2>
      <select id="server"></select>
      <label for="username" class="sr-only">Username</label>
      <input id="username" type="text" class="form-control" name="username" placeholder="Username">
      <label for="password" class="sr-only">Password</label>
      <input id="password" type="text" class="form-control" name="password" placeholder="Password">
      <button class="btn btn-lg btn-primary btn-block" type="submit">Login</button>
    </form>
  </div>

<!--   <div id="response">
  </div>

  <hr> -->

  <div id="projects">
  </div>

<script>

var latest_base_url;
var base_urls;
var csrf_token;

function showResponse(text) {

  // document.getElementById('response').innerHTML = text;
}

function createCORSRequest(method, url) {
  var xhr = new XMLHttpRequest();
  if ("withCredentials" in xhr) {
    xhr.withCredentials = true;
    xhr.open(method, url, true);
  } else if (typeof XDomainRequest != "undefined") {
    xhr = new XDomainRequest();
    xhr.open(method, url);
  } else {
    // CORS is not supported by the browser.
    xhr = null;
  }

  xhr.onerror = function() {
    console.log('There was an error!');
  };
  return xhr;
}

function makeJSONRequest(method, url, callback, data) {
  var xhr = createCORSRequest(method, url);

  xhr.onload = function() {
    var responseText = xhr.responseText;
    var jsonResponse = JSON.parse(responseText);
    if (jsonResponse.message) {
      showResponse(jsonResponse.message);
    } else {
      showResponse("");
    }
    // handle the response.
    if (callback) {
      callback(jsonResponse);
    }
  };

  xhr.setRequestHeader('x-csrftoken', csrf_token);

  if (data) {
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.send(data);
  } else {
    xhr.send();
  }
}

function loadBaseUrls(callback) {
  makeJSONRequest('GET', latest_base_url, function(rsp) {
    base_urls = rsp;
    callback();
  });
}

function prepareLogin() {
  // Get available servers
  var servers_url = base_urls['url:servers'];
  makeJSONRequest('GET', servers_url, function(rsp) {
    var serversHtml = rsp.data.map(function(s){
      return '<option value="' + s.id + '">' + s.server + ':' + s.port + '</option>';
    });
    document.getElementById('server').innerHTML = serversHtml.join("");
  });

  // Also get CSRF token needed for login and other POST requests
  var token_url = base_urls['url:token'];
  makeJSONRequest('GET', token_url, function(rsp) {
    csrf_token = rsp.data;
  });
}

function loadProjects() {
  var projects_url = base_urls['url:projects'];
  makeJSONRequest('GET', projects_url, function(rsp) {
    // hide login form
    document.getElementById('login_container').style.display = 'none';
    var projectsHtml = rsp.data.map(function(p){
      return '<p>' + p['@id'] + ':' + p.Name + '</p>';
    });
    document.getElementById('projects').innerHTML = projectsHtml.join("");
  });
}

document.getElementById('server_form').addEventListener('submit', function(event) {
  event.preventDefault();

  var omeroServer = document.getElementById('base_url').value;
  omeroServer += 'api/';
  // hide form
  document.getElementById('base_url_container').style.display = 'none';
  makeJSONRequest('GET', omeroServer, function(rsp) {
    // List of supported versions
    var versions = rsp.data;
    // Get base_url from last version in the list
    latest_base_url = versions[versions.length-1]["url:base"];
    showResponse('Connecting to ' + latest_base_url);

    // Get the list of top-level urls as starting points, then prepare login form
    loadBaseUrls(prepareLogin);
  });

  return false;
});


document.getElementById('login_form').addEventListener('submit', function(event) {
  event.preventDefault();

  var login_url = base_urls['url:login'];

  var fields = ['username', 'password', 'server'];
  var data = fields.map(function(f){
    return f + '=' + document.getElementById(f).value
  });
  data = data.join('&');
  console.log(data);

  makeJSONRequest('POST', login_url, function(rsp) {
    // Will get eventContext if login OK
    console.log(rsp);

    var ctx = rsp['eventContext'];
    showResponse("Session created: uuid: " + ctx['sessionUuid'] + " in Group: " + ctx['groupName'])
    loadProjects();
  }, data);

  return false;
});

</script>

</body>
</html>
